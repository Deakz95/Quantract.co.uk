# Render Blueprint for Quantract Monorepo
# https://render.com/docs/blueprint-spec

services:
  # CRM Application
  - type: web
    name: quantract-crm
    runtime: node
    region: frankfurt
    rootDir: .
    buildCommand: corepack enable && pnpm install --frozen-lockfile && pnpm --filter @quantract/crm run build
    preDeployCommand: cd apps/crm && pnpm run prisma:generate && pnpm run prisma:migrate:deploy:safe
    startCommand: cd apps/crm && pnpm run start
    healthCheckPath: /api/health
    envVars:
      - key: NODE_ENV
        value: production
      # Neon API credentials (passwordless - no DATABASE_URL/DIRECT_URL stored)
      - key: NEON_API_KEY
        sync: false
      - key: NEON_PROJECT_ID
        sync: false
      - key: NEON_DATABASE
        value: neondb
      - key: NEON_ROLE
        value: neondb_owner
      # App config
      - key: APP_ORIGIN
        value: https://crm.quantract.co.uk
      - key: NEXT_PUBLIC_APP_ORIGIN
        value: https://crm.quantract.co.uk
      - key: QT_USE_PRISMA
        value: "1"
      # Neon Auth - set NEON_AUTH_BASE_URL in Render dashboard from Neon Console
      - key: NEON_AUTH_BASE_URL
        sync: false
      # Better Auth trusted origins - comma-separated list of allowed origins
      - key: BETTER_AUTH_TRUSTED_ORIGINS
        value: https://crm.quantract.co.uk
      # Third-party services
      - key: SENTRY_DSN
        sync: false
      - key: RESEND_API_KEY
        sync: false
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false

  # Marketing Site
  - type: web
    name: quantract-marketing
    runtime: node
    region: frankfurt
    rootDir: .
    buildCommand: corepack enable && pnpm install --frozen-lockfile && pnpm --filter @quantract/marketing run build
    startCommand: cd apps/marketing && pnpm run start
    healthCheckPath: /api/health
    envVars:
      - key: NODE_ENV
        value: production
      - key: APP_ORIGIN
        value: https://www.quantract.co.uk

  # Certificates Application
  - type: web
    name: quantract-certificates
    runtime: node
    region: frankfurt
    rootDir: .
    buildCommand: corepack enable && pnpm install --frozen-lockfile && pnpm --filter @quantract/certificates run build
    startCommand: cd apps/certificates && pnpm run start
    healthCheckPath: /api/health
    envVars:
      - key: NODE_ENV
        value: production
      - key: APP_ORIGIN
        value: https://certificates.quantract.co.uk

  # Tools Application
  - type: web
    name: quantract-tools
    runtime: node
    region: frankfurt
    rootDir: .
    buildCommand: corepack enable && pnpm install --frozen-lockfile && pnpm --filter @quantract/tools run build
    startCommand: cd apps/tools && pnpm run start
    healthCheckPath: /api/health
    envVars:
      - key: NODE_ENV
        value: production
      - key: APP_ORIGIN
        value: https://apps.quantract.co.uk
