# 06 — Client Portal/App

**Status:** COMPLETED

## Intent
Client can view progress, approve changes, and access certs/invoices without friction.

## Scope
- Client portal web/app
- Security for share links
- Document access

## Out of Scope
- Full messaging system
- Payments v2

## Deliverables
- [x] `apps/crm/app/api/client/documents/route.ts` + `apps/crm/app/client/documents/page.tsx` — Secure document viewer for invoices/certs (signed URLs, session-based auth). Auth model: session identity via `requireRole("client")` + `getUserEmail()`. Documents served via time-limited HMAC-signed URLs (5 min TTL) generated by `createSignedUrl()` in `src/lib/server/documents.ts`. Raw storage keys are never exposed to the client.
- [x] `apps/crm/app/client/hub/timeline/page.tsx` + `apps/crm/app/api/client/timeline/route.ts` — Job status timeline with clear dates. API returns 6 event types: `job`, `job_completed`, `invoice`, `invoice_paid`, `certificate`, `quote`. Page renders all types with appropriate icons, colors, and filter pills grouped by category.
- [x] `apps/crm/app/api/client/variations/[token]/decision/route.ts` + `apps/crm/src/lib/server/repo.ts` (`decideVariationByToken`) — Simple approval flow for variations. Client can approve/reject via token-based access. All decisions are logged as `AuditEvent` records with `action: "variation.approved" | "variation.rejected"`, `actorRole: "client"`.

## Acceptance Criteria
- [x] Client cannot access other clients' docs via URL guessing — Token-based routes use 24-byte (192-bit) cryptographically random unique tokens. Session-based routes derive identity from server-side session, not client-supplied params. Certificate PDF route enforces email ownership check (fixed null-clientId bypass).
- [x] Timeline reflects real timestamps — All events use `createdAt`, `updatedAt`, `issuedAt`, `paidAt` from database records. Sorted descending by timestamp.
- [x] Approvals are logged and auditable — `decideVariationByToken()` creates `AuditEvent` records in the database for both approve and reject decisions, with variation ID in metadata.

## Execution Notes (for orchestrator)
- Claude should not create new folders for these docs.
- If a deliverable is not applicable after discovery, mark it as **N/A** and explain why.
- Prefer thin wrappers and minimal diffs where possible.
