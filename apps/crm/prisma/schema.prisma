generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Agreement {
  id              String       @id
  companyId       String
  token           String       @unique
  quoteId         String       @unique
  status          String
  templateVersion String
  quoteSnapshot   Json
  createdAt       DateTime     @default(now())
  updatedAt       DateTime
  signedAt        DateTime?
  signerName      String?
  signerEmail     String?
  signerIp        String?
  signerUserAgent String?
  certificateHash String?
  clientPdfKey    String?
  auditPdfKey     String?
  clientPdfAt     DateTime?
  auditPdfAt      DateTime?
  company         Company      @relation(fields: [companyId], references: [id])
  quote           Quote        @relation(fields: [quoteId], references: [id])
  auditEvents     AuditEvent[]

  @@index([companyId])
}

model AuditEvent {
  id            String       @id
  companyId     String
  entityType    String
  entityId      String
  action        String
  actorRole     String
  actor         String?
  meta          Json?
  createdAt     DateTime     @default(now())
  quoteId       String?
  agreementId   String?
  invoiceId     String?
  jobId         String?
  certificateId String?
  agreement     Agreement?   @relation(fields: [agreementId], references: [id])
  certificate   Certificate? @relation(fields: [certificateId], references: [id])
  company       Company      @relation(fields: [companyId], references: [id])
  invoice       Invoice?     @relation(fields: [invoiceId], references: [id])
  job           Job?         @relation(fields: [jobId], references: [id])
  quote         Quote?       @relation(fields: [quoteId], references: [id])

  @@index([companyId])
  @@index([createdAt])
  @@index([entityType, entityId])
}

model AuthSession {
  id        String    @id
  userId    String
  createdAt DateTime  @default(now())
  expiresAt DateTime
  revokedAt DateTime?
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId, expiresAt])
}

model Certificate {
  id                     String                  @id
  companyId              String
  legalEntityId          String?
  jobId                  String?
  siteId                 String?
  clientId               String?
  type                   String
  status                 String
  certificateNumber      String?
  issuedAt               DateTime?
  inspectorName          String?
  inspectorEmail         String?
  dataVersion            Int                     @default(1)
  data                   Json                    @default("{}")
  completedAt            DateTime?
  pdfKey                 String?
  signedName             String?
  signedAt               DateTime?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime
  auditEvents            AuditEvent[]
  client                 Client?                 @relation(fields: [clientId], references: [id])
  company                Company                 @relation(fields: [companyId], references: [id])
  legalEntity            LegalEntity?            @relation(fields: [legalEntityId], references: [id])
  job                    Job?                    @relation(fields: [jobId], references: [id])
  site                   Site?                   @relation(fields: [siteId], references: [id])
  certificateTestResults CertificateTestResult[]

  @@unique([legalEntityId, certificateNumber])
  @@index([clientId])
  @@index([companyId])
  @@index([legalEntityId])
  @@index([jobId])
  @@index([siteId])
}

model CertificateTestResult {
  id            String      @id
  companyId     String
  certificateId String
  circuitRef    String?
  data          Json
  createdAt     DateTime    @default(now())
  updatedAt     DateTime
  certificate   Certificate @relation(fields: [certificateId], references: [id])
  company       Company     @relation(fields: [companyId], references: [id])

  @@index([certificateId])
  @@index([companyId])
}

model Client {
  id                   String        @id
  companyId            String
  name                 String
  email                String
  phone                String?
  address1             String?
  address2             String?
  city                 String?
  county               String?
  postcode             String?
  country              String?
  notes                String?
  serviceAddress1      String?
  serviceAddress2      String?
  serviceCity          String?
  serviceCounty        String?
  servicePostcode      String?
  serviceCountry       String?
  billingAddress1      String?
  billingAddress2      String?
  billingCity          String?
  billingCounty        String?
  billingPostcode      String?
  billingCountry       String?
  billingSameAsService Boolean       @default(true)
  paymentTermsDays     Int?
  disableAutoChase     Boolean       @default(false)
  xeroContactId        String?
  // SMS consent
  smsOptIn             Boolean       @default(false)
  smsOptInAt           DateTime?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime
  certificates         Certificate[]
  company              Company       @relation(fields: [companyId], references: [id])
  invoices             Invoice[]
  jobs                 Job[]
  quotes               Quote[]
  sites                Site[]
  users                User[]
  tasks                Task[]
  // CRM modules
  contacts             Contact[]
  deals                Deal[]
  activities           Activity[]

  @@unique([companyId, email])
  @@index([companyId])
}

model Company {
  id                      String                  @id
  name                    String
  slug                    String                  @unique
  subdomain               String?                 @unique
  dataTier                String                  @default("shared")
  dedicatedDatabaseUrl    String?
  dataRegion              String                  @default("eu-west-2")
  brandName               String                  @default("Quantract")
  brandTagline            String?
  logoKey                 String?
  themePrimary            String                  @default("#0f172a")
  themeAccent             String                  @default("#16a34a")
  themeBg                 String                  @default("#f8fafc")
  themeText               String                  @default("#0f172a")
  pdfFooterLine1          String?
  pdfFooterLine2          String?
  defaultVatRate          Float                   @default(0.2)
  invoiceNumberPrefix     String                  @default("INV-")
  nextInvoiceNumber       Int                     @default(1)
  certificateNumberPrefix String                  @default("CERT-")
  nextCertificateNumber   Int                     @default(1)
  onboardedAt             DateTime?
  defaultPaymentTermsDays Int                     @default(14)
  autoChaseEnabled        Boolean                 @default(false)
  autoChaseFirstDays      Int                     @default(7)
  autoChaseSecondDays     Int                     @default(14)
  autoChaseThirdDays      Int                     @default(21)
  quoteValidityDays       Int                     @default(30)
  termsAndConditions      String?
  plan                    String                  @default("trial")
  subscriptionStatus      String                  @default("inactive")
  stripeCustomerId        String?
  stripeSubscriptionId    String?
  currentPeriodEnd        DateTime?
  trialEnd                DateTime?
  trialStartedAt          DateTime?
  quotesThisMonth         Int                     @default(0)
  invoicesThisMonth       Int                     @default(0)
  usageResetAt            DateTime?
  xeroConnected           Boolean                 @default(false)
  xeroTenantId            String?
  xeroAccessToken         String?
  xeroRefreshToken        String?
  xeroTokenExpiresAt      DateTime?
  defaultLegalEntityId    String?
  defaultServiceLineId    String?
  // SMS Notification Settings
  smsEnabled              Boolean                 @default(false)
  smsProvider             String? // "twilio" | "messagebird" | etc
  smsSenderId             String? // Sender ID / From number
  smsApiKey               String? // Encrypted API key
  smsApiSecret            String? // Encrypted API secret
  smsRequireConsent       Boolean                 @default(true)
  smsQuietHoursEnabled    Boolean                 @default(false)
  smsQuietFrom            String? // Time string "21:00"
  smsQuietTo              String? // Time string "08:00"
  smsMaxPerClientPerDay   Int                     @default(3)
  smsMaxPerJobPerDay      Int                     @default(5)
  smsCredits              Int                     @default(0)
  // Break-even settings
  workingDaysPerMonth     Int                     @default(22)
  createdAt               DateTime                @default(now())
  updatedAt               DateTime
  agreements              Agreement[]
  auditEvents             AuditEvent[]
  certificates            Certificate[]
  certificateTestResults  CertificateTestResult[]
  clients                 Client[]
  companyUsers            CompanyUser[]
  costItems               CostItem[]
  costItemAttachments     CostItemAttachment[]
  engineers               Engineer[]
  expenses                Expense[]
  invites                 Invite[]
  invoices                Invoice[]
  invoiceAttachments      InvoiceAttachment[]
  invoiceChases           InvoiceChase[]
  invoicePayments         InvoicePayment[]
  invoiceVariations       InvoiceVariation[]
  jobs                    Job[]
  jobBudgetLines          JobBudgetLine[]
  jobStages               JobStage[]
  legalEntities           LegalEntity[]
  serviceLines            ServiceLine[]
  quotes                  Quote[]
  quoteRevisions          QuoteRevision[]
  rateCards               RateCard[]
  companyOverheads        CompanyOverhead[]
  scheduleEntries         ScheduleEntry[]
  sites                   Site[]
  snagItems               SnagItem[]
  subcontractors          Subcontractor[]
  suppliers               Supplier[]
  supplierBills           SupplierBill[]
  supplierBillLines       SupplierBillLine[]
  timeEntries             TimeEntry[]
  timesheets              Timesheet[]
  users                   User[]
  variations              Variation[]
  variationAttachments    VariationAttachment[]
  impersonationLogs       impersonation_logs[]
  checklistTemplates      ChecklistTemplate[]
  jobChecklists           JobChecklist[]
  tasks                   Task[]
  comments                Comment[]
  mentions                Mention[]
  notificationRules       NotificationRule[]
  notificationTemplates   NotificationTemplate[]
  notificationLogs        NotificationLog[]
  inboundIntegrationKeys  InboundIntegrationKey[]
  allowedDomains          AllowedDomain[]
  inboundFormConfigs      InboundFormConfig[]
  // CRM modules
  contacts                Contact[]
  dealStages              DealStage[]
  deals                   Deal[]
  activities              Activity[]
  savedViews              SavedView[]
  importJobs              ImportJob[]
}

model CompanyUser {
  id        String   @id
  companyId String
  userId    String?  // FK to User - nullable during migration, will be backfilled
  email     String   // Kept for backwards compatibility and invite flows
  role      String   // Authoritative role for company-scoped permissions
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime

  company   Company  @relation(fields: [companyId], references: [id])
  user      User?    @relation("UserMemberships", fields: [userId], references: [id])

  @@unique([companyId, email])
  @@unique([companyId, userId]) // Unique membership per user per company (when userId is set)
  @@index([email])
  @@index([userId])
}

// Legal Entity - represents a trading company/LTD under the organization
model LegalEntity {
  id                      String        @id
  companyId               String
  displayName             String // Short name shown in UI (e.g., "Electrical Ltd")
  legalName               String // Full legal name (e.g., "ABC Electrical Services Limited")
  companyNumber           String? // Companies House number
  vatNumber               String? // VAT registration number
  registeredAddress1      String?
  registeredAddress2      String?
  registeredCity          String?
  registeredCounty        String?
  registeredPostcode      String?
  registeredCountry       String?       @default("United Kingdom")
  pdfFooterLine1          String? // Override company footer for this entity
  pdfFooterLine2          String?
  invoiceNumberPrefix     String        @default("INV-")
  nextInvoiceNumber       Int           @default(1)
  certificateNumberPrefix String        @default("CERT-")
  nextCertificateNumber   Int           @default(1)
  isDefault               Boolean       @default(false)
  status                  String        @default("active") // active, inactive
  createdAt               DateTime      @default(now())
  updatedAt               DateTime
  company                 Company       @relation(fields: [companyId], references: [id])
  invoices                Invoice[]
  certificates            Certificate[]
  serviceLines            ServiceLine[] @relation("ServiceLineDefaultEntity")
  jobsPerforming          Job[]         @relation("JobPerformingEntity")

  @@unique([companyId, displayName])
  @@index([companyId])
  @@index([isDefault])
  @@index([status])
}

// Service Line - represents a business division (Electrical, Compliance, Renewables)
model ServiceLine {
  id                   String       @id
  companyId            String
  name                 String // e.g., "Electrical", "Compliance", "Renewables"
  slug                 String // URL-friendly: "electrical", "compliance", "renewables"
  description          String?
  defaultLegalEntityId String? // Default legal entity for this service line
  isDefault            Boolean      @default(false) // Organization default service line
  status               String       @default("active") // active, inactive
  createdAt            DateTime     @default(now())
  updatedAt            DateTime
  company              Company      @relation(fields: [companyId], references: [id])
  defaultLegalEntity   LegalEntity? @relation("ServiceLineDefaultEntity", fields: [defaultLegalEntityId], references: [id])
  jobs                 Job[]

  @@unique([companyId, slug])
  @@index([companyId])
  @@index([isDefault])
  @@index([status])
}

model CostItem {
  id                  String               @id
  companyId           String
  jobId               String
  stageId             String?
  type                String
  source              String               @default("manual")
  lockStatus          String               @default("open")
  supplier            String?
  description         String
  quantity            Float                @default(1)
  unitCost            Float                @default(0)
  markupPct           Float                @default(0)
  incurredAt          DateTime?
  totalCost           Float                @default(0)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime
  company             Company              @relation(fields: [companyId], references: [id])
  job                 Job                  @relation(fields: [jobId], references: [id])
  jobStage            JobStage?            @relation(fields: [stageId], references: [id])
  costItemAttachments CostItemAttachment[]
  supplierBillLines   SupplierBillLine[]

  @@index([companyId])
  @@index([jobId])
  @@index([stageId])
  @@index([type])
}

model CostItemAttachment {
  id         String   @id
  companyId  String
  costItemId String
  name       String
  fileKey    String
  mimeType   String
  createdAt  DateTime @default(now())
  company    Company  @relation(fields: [companyId], references: [id])
  costItem   CostItem @relation(fields: [costItemId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([costItemId])
}

model Engineer {
  id                    String          @id
  companyId             String
  email                 String
  name                  String?
  phone                 String?
  costRatePerHour       Float?
  chargeRatePerHour     Float?
  rateCardId            String?
  isActive              Boolean         @default(true)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime
  address1              String?
  address2              String?
  city                  String?
  county                String?
  postcode              String?
  country               String?
  emergencyName         String?
  emergencyPhone        String?
  emergencyRelationship String?
  company               Company         @relation(fields: [companyId], references: [id])
  rateCard              RateCard?       @relation(fields: [rateCardId], references: [id])
  jobs                  Job[]
  scheduleEntries       ScheduleEntry[]
  timeEntries           TimeEntry[]
  timesheets            Timesheet[]
  users                 User[]

  @@unique([companyId, email])
  @@index([companyId])
}

model Enquiry {
  id            String             @id
  companyId     String
  stageId       String
  ownerId       String? // Owner assignment (User.id)
  formConfigId  String? // Reference to InboundFormConfig if from website
  name          String?
  email         String?
  phone         String?
  postcode      String?
  message       String? // Message/enquiry text from website form
  notes         String? // Internal notes
  valueEstimate Int?
  quoteId       String?
  source        String             @default("manual") // manual | website | api
  pageUrl       String? // URL where form was submitted
  referrer      String? // HTTP referrer
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?
  utmTerm       String?
  utmContent    String?
  metaJson      Json? // Any additional metadata
  createdAt     DateTime           @default(now())
  updatedAt     DateTime
  owner         User?              @relation("EnquiryOwner", fields: [ownerId], references: [id])
  pipelineStage PipelineStage      @relation(fields: [stageId], references: [id])
  formConfig    InboundFormConfig? @relation(fields: [formConfigId], references: [id])
  enquiryEvents EnquiryEvent[]

  @@index([companyId, stageId])
  @@index([ownerId])
  @@index([source])
  @@index([formConfigId])
}

model EnquiryEvent {
  id        String   @id
  companyId String
  enquiryId String
  type      String
  note      String?
  createdAt DateTime @default(now())
  enquiry   Enquiry  @relation(fields: [enquiryId], references: [id], onDelete: Cascade)
}

model Expense {
  id            String        @id
  companyId     String
  jobId         String?
  supplierId    String?
  amount        Int?
  currency      String        @default("GBP")
  expenseDate   DateTime?
  status        ExpenseStatus @default(UPLOADED)
  attachmentKey String?
  parsedData    Json?
  category      String?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  company       Company       @relation(fields: [companyId], references: [id])
  supplier      Supplier?     @relation(fields: [supplierId], references: [id])

  @@index([companyId, status])
}

model Invite {
  id        String    @id
  companyId String
  role      String
  email     String
  name      String?
  token     String    @unique
  expiresAt DateTime?
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  company   Company   @relation(fields: [companyId], references: [id])

  @@index([companyId, email])
  @@index([companyId, role])
}

model Invoice {
  id                 String              @id
  companyId          String
  legalEntityId      String?
  token              String              @unique
  invoiceNumber      String?
  clientId           String?
  quoteId            String?
  jobId              String?
  variationId        String?
  type               String              @default("stage")
  stageName          String?
  clientName         String
  clientEmail        String
  subtotal           Float
  vat                Float
  total              Float
  currency           String              @default("gbp")
  status             String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime
  sentAt             DateTime?
  dueAt              DateTime?
  paidAt             DateTime?
  xeroInvoiceId      String?
  xeroSyncStatus     String              @default("not_synced")
  xeroLastSyncAt     DateTime?
  xeroLastError      String?
  paymentProvider    String?
  paymentUrl         String?
  paymentRef         String?
  auditEvents        AuditEvent[]
  client             Client?             @relation(fields: [clientId], references: [id])
  company            Company             @relation(fields: [companyId], references: [id])
  legalEntity        LegalEntity?        @relation(fields: [legalEntityId], references: [id])
  job                Job?                @relation(fields: [jobId], references: [id])
  quote              Quote?              @relation(fields: [quoteId], references: [id])
  variation          Variation?          @relation(fields: [variationId], references: [id])
  invoiceAttachments InvoiceAttachment[]
  invoiceChases      InvoiceChase[]
  invoicePayments    InvoicePayment[]
  invoiceVariations  InvoiceVariation[]

  @@unique([legalEntityId, invoiceNumber])
  @@index([companyId])
  @@index([legalEntityId])
  @@index([jobId])
  @@index([variationId])
}

model InvoiceAttachment {
  id        String   @id
  companyId String
  invoiceId String
  name      String
  fileKey   String
  mimeType  String
  createdAt DateTime @default(now())
  company   Company  @relation(fields: [companyId], references: [id])
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])

  @@index([companyId])
  @@index([invoiceId])
}

model InvoiceChase {
  id        String   @id
  companyId String
  invoiceId String
  kind      String
  sentAt    DateTime @default(now())
  meta      Json?
  company   Company  @relation(fields: [companyId], references: [id])
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])

  @@unique([companyId, invoiceId, kind])
  @@index([companyId])
  @@index([invoiceId])
}

model InvoicePayment {
  id          String   @id
  companyId   String
  invoiceId   String
  amount      Float
  currency    String   @default("gbp")
  provider    String   @default("stripe")
  status      String   @default("succeeded")
  providerRef String?
  receivedAt  DateTime @default(now())
  company     Company  @relation(fields: [companyId], references: [id])
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])

  @@index([companyId])
  @@index([invoiceId])
}

model InvoiceVariation {
  id          String    @id
  companyId   String
  invoiceId   String
  variationId String
  createdAt   DateTime  @default(now())
  company     Company   @relation(fields: [companyId], references: [id])
  invoice     Invoice   @relation(fields: [invoiceId], references: [id])
  variation   Variation @relation(fields: [variationId], references: [id])

  @@unique([companyId, variationId])
  @@index([companyId])
  @@index([invoiceId])
}

model Job {
  id                      String          @id
  companyId               String
  serviceLineId           String?
  performingLegalEntityId String? // Override: which legal entity performs this job
  quoteId                 String?
  clientId                String?
  siteId                  String
  engineerId              String?
  title                   String?
  status                  String
  scheduledAt             DateTime?
  notes                   String?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime
  budgetSubtotal          Float           @default(0)
  budgetVat               Float           @default(0)
  budgetTotal             Float           @default(0)
  auditEvents             AuditEvent[]
  certificates            Certificate[]
  costItems               CostItem[]
  invoices                Invoice[]
  client                  Client?         @relation(fields: [clientId], references: [id])
  company                 Company         @relation(fields: [companyId], references: [id])
  serviceLine             ServiceLine?    @relation(fields: [serviceLineId], references: [id])
  performingLegalEntity   LegalEntity?    @relation("JobPerformingEntity", fields: [performingLegalEntityId], references: [id])
  engineer                Engineer?       @relation(fields: [engineerId], references: [id])
  quote                   Quote?          @relation(fields: [quoteId], references: [id])
  site                    Site            @relation(fields: [siteId], references: [id])
  jobBudgetLines          JobBudgetLine[]
  jobStages               JobStage[]
  scheduleEntries         ScheduleEntry[]
  snagItems               SnagItem[]
  supplierBills           SupplierBill[]
  timeEntries             TimeEntry[]
  variations              Variation[]
  timesheets              Timesheet[]     @relation("JobTimesheets")
  jobChecklists           JobChecklist[]
  tasks                   Task[]
  comments                Comment[]
  // CRM modules
  activities              Activity[]

  @@index([companyId])
  @@index([serviceLineId])
  @@index([performingLegalEntityId])
  @@index([scheduledAt])
  @@index([status])
}

model ChecklistTemplate {
  id            String                  @id
  companyId     String
  title         String
  description   String?
  isActive      Boolean                 @default(true)
  version       Int                     @default(1)
  createdAt     DateTime                @default(now())
  updatedAt     DateTime
  createdBy     String?
  company       Company                 @relation(fields: [companyId], references: [id])
  items         ChecklistTemplateItem[]
  jobChecklists JobChecklist[]

  @@index([companyId])
  @@index([isActive])
}

model ChecklistTemplateItem {
  id          String            @id
  templateId  String
  title       String
  description String?
  isRequired  Boolean           @default(true)
  sortOrder   Int               @default(0)
  createdAt   DateTime          @default(now())
  template    ChecklistTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId, sortOrder])
}

model JobChecklist {
  id                 String             @id
  companyId          String
  jobId              String
  templateId         String?
  templateSnapshotId String?
  title              String
  description        String?
  attachedAt         DateTime           @default(now())
  attachedBy         String?
  company            Company            @relation(fields: [companyId], references: [id])
  job                Job                @relation(fields: [jobId], references: [id], onDelete: Cascade)
  template           ChecklistTemplate? @relation(fields: [templateId], references: [id])
  items              JobChecklistItem[]

  @@index([companyId])
  @@index([jobId])
}

model JobChecklistItem {
  id              String       @id
  checklistId     String
  title           String
  description     String?
  isRequired      Boolean      @default(true)
  sortOrder       Int          @default(0)
  status          String       @default("pending")
  completedAt     DateTime?
  completedBy     String?
  completedByName String?
  notes           String?
  checklist       JobChecklist @relation(fields: [checklistId], references: [id], onDelete: Cascade)

  @@index([checklistId, sortOrder])
  @@index([status])
}

model Task {
  id           String    @id
  companyId    String
  title        String
  description  String?
  status       String    @default("todo")
  priority     String    @default("medium")
  dueDate      DateTime?
  assigneeId   String?
  jobId        String?
  clientId     String?
  parentTaskId String?
  createdBy    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  completedAt  DateTime?
  company      Company   @relation(fields: [companyId], references: [id])
  assignee     User?     @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator      User?     @relation("TaskCreator", fields: [createdBy], references: [id])
  job          Job?      @relation(fields: [jobId], references: [id])
  client       Client?   @relation(fields: [clientId], references: [id])
  parentTask   Task?     @relation("TaskSubtasks", fields: [parentTaskId], references: [id], onDelete: Cascade)
  subtasks     Task[]    @relation("TaskSubtasks")
  comments     Comment[]
  mentions     Mention[]

  @@index([companyId])
  @@index([assigneeId])
  @@index([jobId])
  @@index([clientId])
  @@index([parentTaskId])
  @@index([status])
  @@index([dueDate])
}

model Comment {
  id           String    @id
  companyId    String
  taskId       String?
  jobId        String?
  content      String
  internalOnly Boolean   @default(true)
  createdBy    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  company      Company   @relation(fields: [companyId], references: [id])
  task         Task?     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  job          Job?      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  creator      User      @relation("CommentCreator", fields: [createdBy], references: [id])
  mentions     Mention[]

  @@index([companyId])
  @@index([taskId])
  @@index([jobId])
  @@index([createdAt])
}

model Mention {
  id        String   @id
  companyId String
  taskId    String?
  commentId String?
  userId    String
  createdAt DateTime @default(now())
  notified  Boolean  @default(false)
  company   Company  @relation(fields: [companyId], references: [id])
  task      Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation("UserMentions", fields: [userId], references: [id])

  @@index([companyId])
  @@index([userId, notified])
  @@index([taskId])
  @@index([commentId])
}

model JobBudgetLine {
  id          String   @id
  companyId   String
  jobId       String
  source      String   @default("quote")
  description String
  quantity    Float    @default(1)
  unitPrice   Float    @default(0)
  total       Float    @default(0)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  company     Company  @relation(fields: [companyId], references: [id])
  job         Job      @relation(fields: [jobId], references: [id])

  @@index([companyId])
  @@index([jobId])
}

model JobStage {
  id          String      @id
  companyId   String
  jobId       String
  name        String
  status      String      @default("not_started")
  sortOrder   Int         @default(0)
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime
  costItems   CostItem[]
  company     Company     @relation(fields: [companyId], references: [id])
  job         Job         @relation(fields: [jobId], references: [id])
  variations  Variation[]

  @@unique([jobId, sortOrder])
  @@index([companyId])
  @@index([jobId])
  @@index([status])
}

model MagicLinkToken {
  id        String    @id
  userId    String
  tokenHash String    @unique
  createdAt DateTime  @default(now())
  expiresAt DateTime
  usedAt    DateTime?
  ip        String?
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId, expiresAt])
}

model MfaSession {
  id             String    @id
  userId         String
  status         String    @default("pending")
  challengeToken String    @unique
  createdAt      DateTime  @default(now())
  expiresAt      DateTime
  verifiedAt     DateTime?
  ipAddress      String?
  userAgent      String?
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([userId, status])
}

model NotificationPreference {
  id        String   @id
  userId    String
  channel   String
  category  String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, channel, category])
  @@index([userId])
}

model PipelineStage {
  id        String    @id
  companyId String
  name      String
  sortOrder Int       @default(0)
  color     String?
  isWon     Boolean   @default(false)
  isLost    Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime
  enquiries Enquiry[]

  @@index([companyId, sortOrder])
}

model PurchaseOrder {
  id         String              @id
  companyId  String
  supplierId String
  jobId      String?
  status     PurchaseOrderStatus @default(DRAFT)
  poNumber   String
  createdAt  DateTime            @default(now())
  updatedAt  DateTime

  @@unique([companyId, poNumber])
}

model PurchaseOrderLine {
  id              String @id
  purchaseOrderId String
  description     String
  qty             Int
  unitCost        Int
  total           Int
}

model Quote {
  id             String          @id
  companyId      String
  token          String          @unique
  clientId       String?
  siteId         String?
  version        Int             @default(1)
  clientName     String
  clientEmail    String
  siteAddress    String?
  notes          String?
  vatRate        Float
  items          Json
  status         String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime
  acceptedAt     DateTime?
  agreement      Agreement?
  auditEvents    AuditEvent[]
  invoices       Invoice[]
  jobs           Job[]
  client         Client?         @relation(fields: [clientId], references: [id])
  company        Company         @relation(fields: [companyId], references: [id])
  site           Site?           @relation(fields: [siteId], references: [id])
  quoteRevisions QuoteRevision[]
  variations     Variation[]

  @@index([clientId])
  @@index([companyId])
}

model QuoteRevision {
  id        String   @id
  companyId String
  quoteId   String
  version   Int
  snapshot  Json
  createdAt DateTime @default(now())
  company   Company  @relation(fields: [companyId], references: [id])
  quote     Quote    @relation(fields: [quoteId], references: [id])

  @@unique([quoteId, version])
  @@index([companyId])
  @@index([createdAt])
  @@index([quoteId])
}

model RateCard {
  id                String     @id
  companyId         String
  name              String
  costRatePerHour   Float      @default(0)
  chargeRatePerHour Float      @default(0)
  isDefault         Boolean    @default(false)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime
  engineers         Engineer[]
  company           Company    @relation(fields: [companyId], references: [id])

  @@unique([companyId, name])
  @@index([companyId])
}

model CompanyOverhead {
  id          String   @id
  companyId   String
  label       String
  amountPence Int      @default(0)
  frequency   String   @default("monthly") // monthly | weekly | annual
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  company     Company  @relation(fields: [companyId], references: [id])

  @@index([companyId])
}

model ScheduleEntry {
  id         String   @id
  companyId  String
  jobId      String
  engineerId String
  startAt    DateTime
  endAt      DateTime
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  company    Company  @relation(fields: [companyId], references: [id])
  engineer   Engineer @relation(fields: [engineerId], references: [id])
  job        Job      @relation(fields: [jobId], references: [id])

  @@index([companyId])
  @@index([engineerId, startAt])
  @@index([jobId])
}

model Site {
  id               String        @id
  companyId        String
  clientId         String
  name             String?
  address1         String?
  address2         String?
  city             String?
  county           String?
  postcode         String?
  country          String?
  notes            String?
  paymentTermsDays Int?
  disableAutoChase Boolean       @default(false)
  xeroContactId    String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime
  certificates     Certificate[]
  jobs             Job[]
  quotes           Quote[]
  client           Client        @relation(fields: [clientId], references: [id])
  company          Company       @relation(fields: [companyId], references: [id])

  @@index([clientId])
  @@index([companyId])
}

model SnagItem {
  id          String    @id
  companyId   String
  jobId       String
  title       String
  description String?
  status      String    @default("open")
  resolvedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  company     Company   @relation(fields: [companyId], references: [id])
  job         Job       @relation(fields: [jobId], references: [id])

  @@index([companyId])
  @@index([jobId])
  @@index([status])
}

model StockItem {
  id           String   @id
  companyId    String
  sku          String?
  name         String
  unit         String
  defaultCost  Int?
  reorderLevel Int?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime

  @@index([companyId, isActive])
}

model StockMovement {
  id          String            @id
  companyId   String
  stockItemId String
  type        StockMovementType
  qtyDelta    Int
  refType     String?
  refId       String?
  createdAt   DateTime          @default(now())

  @@index([companyId, stockItemId])
}

model Subcontractor {
  id        String   @id
  companyId String
  name      String
  trade     String?
  email     String?
  phone     String?
  dayRate   Int?
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime
  company   Company  @relation(fields: [companyId], references: [id])

  @@index([companyId])
}

model Supplier {
  id        String    @id
  companyId String
  name      String
  email     String?
  phone     String?
  address   String?
  notes     String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime
  expenses  Expense[]
  company   Company   @relation(fields: [companyId], references: [id])

  @@index([companyId])
}

model SupplierBill {
  id                String             @id
  companyId         String
  jobId             String
  supplier          String
  reference         String?
  billDate          DateTime?
  status            String             @default("draft")
  postedAt          DateTime?
  subtotal          Float              @default(0)
  vat               Float              @default(0)
  total             Float              @default(0)
  pdfKey            String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime
  company           Company            @relation(fields: [companyId], references: [id])
  job               Job                @relation(fields: [jobId], references: [id])
  supplierBillLines SupplierBillLine[]

  @@index([companyId])
  @@index([jobId])
}

model SupplierBillLine {
  id           String       @id
  companyId    String
  billId       String
  description  String
  quantity     Float        @default(1)
  unitCost     Float        @default(0)
  vatRate      Float        @default(0.2)
  totalExVat   Float        @default(0)
  costItemId   String?
  createdAt    DateTime     @default(now())
  supplierBill SupplierBill @relation(fields: [billId], references: [id], onDelete: Cascade)
  company      Company      @relation(fields: [companyId], references: [id])
  costItem     CostItem?    @relation(fields: [costItemId], references: [id])

  @@index([billId])
  @@index([companyId])
}

model TimeEntry {
  id           String     @id
  companyId    String
  jobId        String
  engineerId   String
  timesheetId  String?
  startedAt    DateTime
  endedAt      DateTime?
  breakMinutes Int        @default(0)
  notes        String?
  status       String     @default("draft")
  lockedAt     DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime
  company      Company    @relation(fields: [companyId], references: [id])
  engineer     Engineer   @relation(fields: [engineerId], references: [id])
  job          Job        @relation(fields: [jobId], references: [id])
  timesheet    Timesheet? @relation(fields: [timesheetId], references: [id])

  @@index([companyId])
  @@index([engineerId])
  @@index([jobId])
  @@index([startedAt])
}

model Timesheet {
  id          String      @id
  companyId   String
  engineerId  String
  weekStart   DateTime
  status      String      @default("draft")
  submittedAt DateTime?
  approvedAt  DateTime?
  approvedBy  String?
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime
  timeEntries TimeEntry[]
  company     Company     @relation(fields: [companyId], references: [id])
  engineer    Engineer    @relation(fields: [engineerId], references: [id])
  jobs        Job[]       @relation("JobTimesheets")

  @@unique([companyId, engineerId, weekStart])
  @@index([companyId])
  @@index([status])
  @@index([weekStart])
}

model User {
  id                        String                   @id
  neonAuthUserId            String?                  @unique
  companyId                 String?
  role                      String
  email                     String
  name                      String?
  passwordHash              String?
  engineerId                String?
  clientId                  String?
  createdAt                 DateTime                 @default(now())
  updatedAt                 DateTime
  profileComplete           Boolean                  @default(false)
  address1                  String?
  address2                  String?
  city                      String?
  county                    String?
  postcode                  String?
  country                   String?
  emergencyName             String?
  emergencyPhone            String?
  emergencyRelationship     String?
  mfaEnabled                Boolean                  @default(false)
  mfaSecret                 String?
  mfaBackupCodes            String?
  mfaEnrolledAt             DateTime?
  mfaVerifiedAt             DateTime?
  mfaRequiredBy             DateTime?
  currentImpersonationId    String?
  authSessions              AuthSession[]
  magicLinkTokens           MagicLinkToken[]
  mfaSessions               MfaSession[]
  notificationPreferences   NotificationPreference[]
  client                    Client?                  @relation(fields: [clientId], references: [id])
  company                   Company?                 @relation(fields: [companyId], references: [id])
  engineer                  Engineer?                @relation(fields: [engineerId], references: [id])
  impersonationLogsAsAdmin  impersonation_logs[]     @relation("impersonation_logs_adminUserIdToUser")
  impersonationLogsAsTarget impersonation_logs[]     @relation("impersonation_logs_targetUserIdToUser")
  enquiriesOwned            Enquiry[]                @relation("EnquiryOwner")
  tasksAssigned             Task[]                   @relation("TaskAssignee")
  tasksCreated              Task[]                   @relation("TaskCreator")
  commentsCreated           Comment[]                @relation("CommentCreator")
  mentions                  Mention[]                @relation("UserMentions")
  // CRM modules
  dealsOwned                Deal[]                   @relation("DealOwner")
  activitiesCreated         Activity[]               @relation("ActivityCreator")
  savedViews                SavedView[]              @relation("UserSavedViews")
  importJobs                ImportJob[]              @relation("UserImports")
  // Company memberships (authoritative for company-scoped permissions)
  memberships               CompanyUser[]            @relation("UserMemberships")

  @@unique([role, email])
  @@index([companyId])
}

model UserPermission {
  id        String   @id
  companyId String
  userId    String
  key       String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@unique([companyId, userId, key])
  @@index([companyId, userId])
}

model Variation {
  id                   String                @id
  companyId            String
  token                String                @unique
  quoteId              String?
  jobId                String?
  stageId              String?
  title                String
  reason               String?
  notes                String?
  status               String
  vatRate              Float
  items                Json
  subtotal             Float                 @default(0)
  vat                  Float                 @default(0)
  total                Float                 @default(0)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime
  sentAt               DateTime?
  approvedAt           DateTime?
  rejectedAt           DateTime?
  approvedBy           String?
  invoices             Invoice[]
  invoiceVariations    InvoiceVariation[]
  company              Company               @relation(fields: [companyId], references: [id])
  job                  Job?                  @relation(fields: [jobId], references: [id])
  quote                Quote?                @relation(fields: [quoteId], references: [id])
  jobStage             JobStage?             @relation(fields: [stageId], references: [id])
  variationAttachments VariationAttachment[]

  @@index([companyId])
  @@index([stageId])
  @@index([status])
}

model VariationAttachment {
  id          String    @id
  companyId   String
  variationId String
  name        String
  fileKey     String
  mimeType    String
  createdAt   DateTime  @default(now())
  company     Company   @relation(fields: [companyId], references: [id])
  variation   Variation @relation(fields: [variationId], references: [id])

  @@index([companyId])
  @@index([variationId])
}

model impersonation_logs {
  id           String    @id
  adminUserId  String
  targetUserId String
  reason       String?
  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  actionsTaken Json      @default("[]")
  ipAddress    String?   @db.VarChar(45)
  userAgent    String?
  companyId    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime
  adminUser    User      @relation("impersonation_logs_adminUserIdToUser", fields: [adminUserId], references: [id], onDelete: Cascade)
  company      Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  targetUser   User      @relation("impersonation_logs_targetUserIdToUser", fields: [targetUserId], references: [id], onDelete: Cascade)

  @@index([adminUserId])
  @@index([companyId])
  @@index([endedAt])
  @@index([targetUserId])
}

enum ExpenseStatus {
  UPLOADED
  PARSED
  CONFIRMED
  POSTED
}

enum PurchaseOrderStatus {
  DRAFT
  SENT
  CONFIRMED
  RECEIVED
  CANCELLED
}

enum StockMovementType {
  RECEIVED
  USED
  ADJUSTMENT
}

enum UserRole {
  ADMIN
  OFFICE
  ENGINEER
  FINANCE
}

// ============================================================================
// NOTIFICATION SYSTEM
// ============================================================================

enum NotificationChannel {
  SMS
  EMAIL
}

enum NotificationEventKey {
  // Appointments & Jobs
  appointmentBooked
  appointmentReminder24h
  appointmentReminder2h
  engineerOnTheWay
  jobCompleted
  // Quotes
  quoteSent
  quoteReminder
  quoteAccepted
  // Invoices & Payments
  invoiceIssued
  invoiceOverdue
  invoiceFinalReminder
  paymentReceived
  // Certificates
  certificateIssued
  // Portal
  portalInvite
}

enum NotificationLogStatus {
  sent
  skipped
  failed
}

enum NotificationSkipReason {
  noConsent
  noCredits
  quietHours
  rateLimited
  missingPhone
  missingEmail
  disabled
  providerError
}

// Notification rules per company - which events are enabled for which channel
model NotificationRule {
  id        String               @id
  companyId String
  channel   NotificationChannel
  eventKey  NotificationEventKey
  enabled   Boolean              @default(true)
  createdAt DateTime             @default(now())
  updatedAt DateTime
  company   Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, channel, eventKey])
  @@index([companyId])
}

// Notification templates per company
model NotificationTemplate {
  id        String               @id
  companyId String
  channel   NotificationChannel
  eventKey  NotificationEventKey
  subject   String? // For email
  body      String
  isDefault Boolean              @default(false)
  createdAt DateTime             @default(now())
  updatedAt DateTime
  company   Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, channel, eventKey])
  @@index([companyId])
}

// Notification logs for auditing
model NotificationLog {
  id                String                  @id
  companyId         String
  channel           NotificationChannel
  eventKey          NotificationEventKey
  recipient         String // Phone number or email
  clientId          String?
  jobId             String?
  invoiceId         String?
  quoteId           String?
  certificateId     String?
  status            NotificationLogStatus
  skipReason        NotificationSkipReason?
  errorMessage      String?
  cost              Int? // Cost in pence for SMS
  segments          Int? // SMS segments used
  providerMessageId String?
  createdAt         DateTime                @default(now())
  company           Company                 @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([companyId, createdAt])
  @@index([companyId, channel])
  @@index([clientId])
  @@index([status])
}

// ============================================================================
// INBOUND LEAD CAPTURE SYSTEM
// ============================================================================

// API keys for inbound integrations (website forms, external systems)
model InboundIntegrationKey {
  id          String    @id
  companyId   String
  name        String // Friendly name e.g., "Main Website", "Landing Page"
  keyHash     String    @unique // HMAC-SHA256 hash of the actual key (actual key is never stored)
  keyPrefix   String // First 8 chars of key for identification (e.g., "qt_live_a1b2...")
  permissions String    @default("enquiry:create") // Comma-separated permissions
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  lastUsedAt  DateTime?
  usageCount  Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, name])
  @@index([companyId])
  @@index([keyHash])
  @@index([isActive])
}

// Allowed domains for CORS and referer validation
model AllowedDomain {
  id              String    @id
  companyId       String
  domain          String // e.g., "example.com" or "*.example.com"
  isVerified      Boolean   @default(false)
  verificationKey String? // Optional DNS TXT record verification key
  verifiedAt      DateTime?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  company         Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, domain])
  @@index([companyId])
  @@index([domain])
  @@index([isActive])
}

// Form configurations for inbound forms
model InboundFormConfig {
  id                 String    @id
  companyId          String
  name               String // e.g., "Contact Form", "Quote Request"
  slug               String // URL-friendly identifier
  defaultStageId     String? // Pipeline stage for new enquiries from this form
  defaultOwnerId     String? // Default owner assignment
  requiredFields     Json      @default("[\"name\", \"email\"]") // Array of required field names
  optionalFields     Json      @default("[\"phone\", \"message\"]") // Array of optional field names
  thankYouMessage    String? // Custom thank you message
  redirectUrl        String? // URL to redirect after submission
  notifyEmails       String? // Comma-separated emails to notify on submission
  enableCaptcha      Boolean   @default(true)
  enableHoneypot     Boolean   @default(true)
  rateLimitPerMinute Int       @default(5) // Max submissions per minute per IP
  isActive           Boolean   @default(true)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime
  company            Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  enquiries          Enquiry[]

  @@unique([companyId, slug])
  @@index([companyId])
  @@index([slug])
  @@index([isActive])
}

// ============================================================================
// CRM MODULES - Contacts, Deals Pipeline, Activities
// ============================================================================

// CONTACTS - Multiple contacts per client
model Contact {
  id               String   @id
  companyId        String
  clientId         String?
  firstName        String
  lastName         String
  email            String?
  phone            String?
  mobile           String?
  jobTitle         String?
  isPrimary        Boolean  @default(false)
  preferredChannel String   @default("email")
  notes            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime

  company    Company    @relation(fields: [companyId], references: [id])
  client     Client?    @relation(fields: [clientId], references: [id])
  deals      Deal[]
  activities Activity[]

  @@unique([companyId, email])
  @@index([companyId])
  @@index([clientId])
}

// DEAL STAGES - Pipeline columns
model DealStage {
  id          String   @id
  companyId   String
  name        String
  color       String?
  sortOrder   Int      @default(0)
  probability Int?
  isWon       Boolean  @default(false)
  isLost      Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  company Company @relation(fields: [companyId], references: [id])
  deals   Deal[]

  @@unique([companyId, name])
  @@index([companyId, sortOrder])
}

// DEALS - Opportunities with Kanban support
model Deal {
  id                String    @id
  companyId         String
  stageId           String
  contactId         String?
  clientId          String?
  ownerId           String?
  title             String
  value             Float     @default(0)
  probability       Int?
  expectedCloseDate DateTime?
  closedAt          DateTime?
  lostReason        String?
  notes             String?
  source            String    @default("manual")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime

  company    Company    @relation(fields: [companyId], references: [id])
  stage      DealStage  @relation(fields: [stageId], references: [id])
  contact    Contact?   @relation(fields: [contactId], references: [id])
  client     Client?    @relation(fields: [clientId], references: [id])
  owner      User?      @relation("DealOwner", fields: [ownerId], references: [id])
  activities Activity[]

  @@index([companyId])
  @@index([stageId])
  @@index([ownerId])
}

// ACTIVITIES - Universal activity log
model Activity {
  id          String   @id
  companyId   String
  type        String // NOTE, CALL, EMAIL, MEETING, TASK, STAGE_CHANGE
  subject     String
  description String?
  contactId   String?
  dealId      String?
  clientId    String?
  jobId       String?
  createdBy   String
  occurredAt  DateTime @default(now())
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  company Company  @relation(fields: [companyId], references: [id])
  contact Contact? @relation(fields: [contactId], references: [id])
  deal    Deal?    @relation(fields: [dealId], references: [id])
  client  Client?  @relation(fields: [clientId], references: [id])
  job     Job?     @relation(fields: [jobId], references: [id])
  creator User     @relation("ActivityCreator", fields: [createdBy], references: [id])

  @@index([companyId])
  @@index([contactId])
  @@index([dealId])
  @@index([clientId])
  @@index([jobId])
}

// SAVED VIEWS - User filter configurations
model SavedView {
  id         String   @id
  companyId  String
  userId     String
  name       String
  entityType String // contacts, deals, clients, jobs
  filters    Json
  columns    Json?
  sortBy     String?
  sortDir    String?
  isDefault  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime

  company Company @relation(fields: [companyId], references: [id])
  user    User    @relation("UserSavedViews", fields: [userId], references: [id])

  @@unique([companyId, userId, name, entityType])
  @@index([companyId, entityType])
}

// IMPORT JOBS - Track import progress
model ImportJob {
  id            String    @id
  companyId     String
  userId        String
  entityType    String
  fileName      String
  fileKey       String
  status        String    @default("pending")
  totalRows     Int?
  processedRows Int       @default(0)
  successCount  Int       @default(0)
  errorCount    Int       @default(0)
  mapping       Json
  errors        Json?
  createdAt     DateTime  @default(now())
  completedAt   DateTime?

  company Company @relation(fields: [companyId], references: [id])
  user    User    @relation("UserImports", fields: [userId], references: [id])

  @@index([companyId])
  @@index([status])
}
